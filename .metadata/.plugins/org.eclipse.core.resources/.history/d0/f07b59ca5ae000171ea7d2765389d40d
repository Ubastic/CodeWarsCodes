import java.util.Arrays;

//Solution http://www.codewars.com/kata/52a78825cdfc2cfc87000005/train/java
public class MathEvaluator {

	public static double calculate(String exp){
		
		//convert 2/((2+3)*4.33)--6 to 2 / ( ( 2 + 3 * 2) * ( 4.1 * 10 ) ) + 6
		exp = exp.replace(" ","");
		exp = exp.replaceAll("[\\D && [^\\.]]"," $0 ");
		exp = exp.replaceAll("  ", " ");
		exp = exp.replace(" - - ", " + ");
		
		boolean noMoreParentheses = false;
		
		//determine innermost parentheses following OOP and take out the substring 2 + 3 * 2
		while(true){
			
			String temp = findInnerParentheses(exp);
			String[] tempParts = temp.split(",");
			int indexA = Integer.parseInt(tempParts[0]);
			int indexB = Integer.parseInt(tempParts[1]);
			String s = "";
			if(indexA != -1 && indexB != -1)
				s = exp.substring(indexA, indexB + 1);
			else{
				noMoreParentheses = true;
				s = exp;
			}
			
			//System.out.println(s);
			
			//evaluate
			String t = evaluate(s);
			
			//replace
			if(!noMoreParentheses)
				exp = exp.substring(0,indexA) + t + exp.substring(indexB + 1);
			else{
				//t.replace(" ",""); <-- not sure if I need this
				return Double.parseDouble(t);
			}
			
		}
		
	}
	
	public static String findInnerParentheses(String s){
		int innerIndexA = -1;
		int innerMaxCount = 0;
		int innerCount = 0;
		for(int i = 0; i < s.length(); i++){
			if(s.charAt(i) == '(')
				innerCount++;
			else if(s.charAt(i) == ')')
				innerCount--;
			if(innerCount > innerMaxCount){
				innerIndexA = i;
				innerMaxCount = innerCount;
			}
		}
		int innerIndexB = innerIndexA + 1;
		while(true){
			if(s.charAt(innerIndexB) == ')')
				break;
			else
				innerIndexB++;
		}
		return Integer.toString(innerIndexA) + "," + Integer.toString(innerIndexB);
	}

	public static String evaluate(String s){
		s = s.replace("( ","");
		s = s.replace(" )","");
		//System.out.println(s);
		String[] strParts = s.split(" ");
		/*
		for(int i = 0; i < strParts.length; i++)
			System.out.println(strParts[i]);
		*/
		for(int i = 0; i < strParts.length; i++){
			if(strParts[i].equals("*")){
				double a = Double.parseDouble(strParts[i-1]);
				double b = Double.parseDouble(strParts[i+1]);
				double prod = a * b;
				strParts[i] = Double.toString(prod);
				strParts[i-1] = "";
				strParts[i+1] = "";
				i++;
			}
			else if(strParts[i].equals("/")){
				double a = Double.parseDouble(strParts[i-1]);
				double b = Double.parseDouble(strParts[i+1]);
				double quot = a / b;
				strParts[i] = Double.toString(quot);
				strParts[i-1] = "";
				strParts[i+1] = "";
				i++;
			}	
		}
		s = "";
		for(int i = 0; i < strParts.length; i++)
			s += strParts[i];
		s = s.replaceAll("[\\D && [^\\.]]"," $0 ");
		s = s.replaceAll("  ", " ");
		System.out.println("S here: " + s);
		
		strParts = s.split(" ");
		
		
		for(int i = 0; i < strParts.length; i++)
			System.out.println(strParts[i]);
		
		for(int i = 0; i < strParts.length; i++){
			if(strParts[i].equals("+")){
				System.out.println("in + ");
				double a = Double.parseDouble(strParts[i-1]);
				System.out.println("a is: " + a);
				double b = Double.parseDouble(strParts[i+1]);
				System.out.println("b is: " + b);
				double sum = a + b;
				System.out.println("sum is: " + sum);
				strParts[i] = Double.toString(sum);
				System.out.println(strParts[i]);
				strParts[i-1] = "";
				strParts[i+1] = "";
				i++;
			}
			else if(strParts[i].equals("-")){
				double a = Double.parseDouble(strParts[i-1]);
				double b = Double.parseDouble(strParts[i+1]);
				double diff = a / b;
				strParts[i] = Double.toString(diff);
				strParts[i-1] = "";
				strParts[i+1] = "";
				i++;
			}	
		}
		System.out.println(s);
		return s;
	}
	
}
